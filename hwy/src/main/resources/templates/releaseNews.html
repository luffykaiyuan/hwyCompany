<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link rel="shortcut icon" href="favicon.ico">
    <!-- import Vue before Element -->
    <script src="./js/jquery.js"></script>
    <script src="./js/vue.js"></script>
    <!-- import JavaScript -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.staticfile.org/axios/0.18.0/axios.min.js"></script>
    <title>æ–°é—»å‘å¸ƒ</title>
</head>
<style>
    [v-cloak]{
        display: none;
    }
    .w-e-text-container{
        height: 700px !important;/*!importantæ˜¯é‡ç‚¹ï¼Œå› ä¸ºåŸdivæ˜¯è¡Œå†…æ ·å¼è®¾ç½®çš„é«˜åº¦300px*/
    }
</style>
<body>
<span style="font-size: 20px;font-weight: normal; color: rgba(52,148,243,1)">â–Œ</span>æ–°é—»å‘å¸ƒ
<hr>
<div style="text-align: center">
    æ–°é—»æ ‡é¢˜ï¼š<input type="text" name="newsTitle" id="newsTitle"/>
</div>
<br>
<div id="editor">

</div>
<hr>
<br>
<div id="app" v-cloak>
    <el-row>
        <el-col :span="2" :offset="9">
            <el-button style="display:block;margin:0 auto" type="primary" @click="submitForm">å‘å¸ƒæ–°é—»</el-button>
        </el-col>
        <el-col :span="2" :offset="1">
            <el-button style="display:block;margin:0 auto" @click="backIndex">è¿”å›é¦–é¡µ</el-button>
        </el-col>
    </el-row>
</div>
</body>
<!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ ï¼ï¼ï¼-->
<script type="text/javascript" src="./js/wangEditor.js"></script>
<script type="text/javascript">
    var E = window.wangEditor
    var editor = new E('#editor') // ä¸¤ä¸ªå‚æ•°ä¹Ÿå¯ä»¥ä¼ å…¥ elem å¯¹è±¡ï¼Œclass é€‰æ‹©å™¨
    // editor.customConfig.uploadImgShowBase64 = true // ä½¿ç”¨ base64 ä¿å­˜å›¾ç‰‡
    // é…ç½®æœåŠ¡å™¨ç«¯åœ°å€
    editor.customConfig.uploadImgServer = '/img/upload'
    // å°†å›¾ç‰‡å¤§å°é™åˆ¶ä¸º 3M
    editor.customConfig.uploadImgMaxSize = 3 * 1024 * 1024;
    // éšè—â€œç½‘ç»œå›¾ç‰‡â€tab
    editor.customConfig.showLinkImg = false
    // è‡ªå®šä¹‰ä¸Šä¼ å‚æ•°
    editor.customConfig.uploadFileName = 'imgFile'
    editor.customConfig.uploadImgHooks = {
        before : function(xhr, editor, files) {
            // å›¾ç‰‡ä¸Šä¼ ä¹‹å‰è§¦å‘
            // xhr æ˜¯ XMLHttpRequst å¯¹è±¡ï¼Œeditor æ˜¯ç¼–è¾‘å™¨å¯¹è±¡ï¼Œfiles æ˜¯é€‰æ‹©çš„å›¾ç‰‡æ–‡ä»¶

            // å¦‚æœè¿”å›çš„ç»“æœæ˜¯ {prevent: true, msg: 'xxxx'} åˆ™è¡¨ç¤ºç”¨æˆ·æ”¾å¼ƒä¸Šä¼ 
            // return {
            //     prevent: true,
            //     msg: 'æ”¾å¼ƒä¸Šä¼ '
            // }
        },
        success : function(xhr, editor, result) {
            // å›¾ç‰‡ä¸Šä¼ å¹¶è¿”å›ç»“æœï¼Œå›¾ç‰‡æ’å…¥æˆåŠŸä¹‹åè§¦å‘
            // xhr æ˜¯ XMLHttpRequst å¯¹è±¡ï¼Œeditor æ˜¯ç¼–è¾‘å™¨å¯¹è±¡ï¼Œresult æ˜¯æœåŠ¡å™¨ç«¯è¿”å›çš„ç»“æœ
        },
        fail : function(xhr, editor, result) {
            // å›¾ç‰‡ä¸Šä¼ å¹¶è¿”å›ç»“æœï¼Œä½†å›¾ç‰‡æ’å…¥é”™è¯¯æ—¶è§¦å‘
            // xhr æ˜¯ XMLHttpRequst å¯¹è±¡ï¼Œeditor æ˜¯ç¼–è¾‘å™¨å¯¹è±¡ï¼Œresult æ˜¯æœåŠ¡å™¨ç«¯è¿”å›çš„ç»“æœ
        },
        error : function(xhr, editor) {
            // å›¾ç‰‡ä¸Šä¼ å‡ºé”™æ—¶è§¦å‘
            // xhr æ˜¯ XMLHttpRequst å¯¹è±¡ï¼Œeditor æ˜¯ç¼–è¾‘å™¨å¯¹è±¡
        },
        timeout : function(xhr, editor) {
            // å›¾ç‰‡ä¸Šä¼ è¶…æ—¶æ—¶è§¦å‘
            // xhr æ˜¯ XMLHttpRequst å¯¹è±¡ï¼Œeditor æ˜¯ç¼–è¾‘å™¨å¯¹è±¡
        },

        // å¦‚æœæœåŠ¡å™¨ç«¯è¿”å›çš„ä¸æ˜¯ {errno:0, data: [...]} è¿™ç§æ ¼å¼ï¼Œå¯ä½¿ç”¨è¯¥é…ç½®
        // ï¼ˆä½†æ˜¯ï¼ŒæœåŠ¡å™¨ç«¯è¿”å›çš„å¿…é¡»æ˜¯ä¸€ä¸ª JSON æ ¼å¼å­—ç¬¦ä¸²ï¼ï¼ï¼å¦åˆ™ä¼šæŠ¥é”™ï¼‰
        customInsert : function(insertImg, result, editor) {
            // å›¾ç‰‡ä¸Šä¼ å¹¶è¿”å›ç»“æœï¼Œè‡ªå®šä¹‰æ’å…¥å›¾ç‰‡çš„äº‹ä»¶ï¼ˆè€Œä¸æ˜¯ç¼–è¾‘å™¨è‡ªåŠ¨æ’å…¥å›¾ç‰‡ï¼ï¼ï¼ï¼‰
            // insertImg æ˜¯æ’å…¥å›¾ç‰‡çš„å‡½æ•°ï¼Œeditor æ˜¯ç¼–è¾‘å™¨å¯¹è±¡ï¼Œresult æ˜¯æœåŠ¡å™¨ç«¯è¿”å›çš„ç»“æœ

            // ä¸¾ä¾‹ï¼šå‡å¦‚ä¸Šä¼ å›¾ç‰‡æˆåŠŸåï¼ŒæœåŠ¡å™¨ç«¯è¿”å›çš„æ˜¯ {url:'....'} è¿™ç§æ ¼å¼ï¼Œå³å¯è¿™æ ·æ’å…¥å›¾ç‰‡ï¼š
            var url = result.url
            insertImg(url)

            // result å¿…é¡»æ˜¯ä¸€ä¸ª JSON æ ¼å¼å­—ç¬¦ä¸²ï¼ï¼ï¼å¦åˆ™æŠ¥é”™
        }
    }
    //é…ç½®èœå•
    editor.customConfig.menus = [
        'head',
        'bold',
        'fontSize',
        'fontName',
        'italic',
        'underline',
        'strikeThrough',
        'foreColor',
        'backColor',
        'link',
        'list',
        'justify',
        'emoticon',
        'image',
        'table',
        'undo',
        'redo',
    ]
    // è¡¨æƒ…é¢æ¿å¯ä»¥æœ‰å¤šä¸ª tab ï¼Œå› æ­¤è¦é…ç½®æˆä¸€ä¸ªæ•°ç»„ã€‚æ•°ç»„æ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ä¸ª tab çš„é…ç½®
    editor.customConfig.emotions = [
        {
            // tab çš„æ ‡é¢˜
            title: 'é»˜è®¤',
            // type -> 'emoji' / 'image'
            type: 'image',
            // content -> æ•°ç»„
            content: [
                {
                    alt: '[åç¬‘]',
                    src: 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/50/pcmoren_huaixiao_org.png'
                },
                {
                    alt: '[èˆ”å±]',
                    src: 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/pcmoren_tian_org.png'
                }
            ]
        },
        {
            // tab çš„æ ‡é¢˜
            title: 'emoji',
            // type -> 'emoji' / 'image'
            type: 'emoji',
            // content -> æ•°ç»„
            content: ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†']
        }
    ]
    // å¿…é¡»æ”¾åˆ°æœ‰å…³äºç¼–è¾‘å™¨è®¾ç½®å‰é¢
    editor.create()
</script>
<!--VUEçš„ä¸œè¥¿-->
<script>
    var vue1 = new Vue({
        el: '#app',
        data: function () {
            return {
                contextPath:'',
                urls:{
                    insertNews: '/news/insertNews',
                    updateNews: '/news/updateNews',
                    initNews: '/news/selectByPrimaryKey'
                },
                newsForm: {
                    id: '',
                    newsTitle: '',
                    newsContent: '',
                },
                suFlag: 'save'
            }
        },
        created: function () {
            var contextPath = document.location.pathname;
            var contextPath = contextPath.split('/')[1];
            var contextPath = "/" + contextPath;
            this.contextPath = contextPath;
            var self = this;

            var loc = location.href;//è·å–æ•´ä¸ªè·³è½¬åœ°å€å†…å®¹ï¼Œå…¶å®å°±æ˜¯ä½ ä¼ è¿‡æ¥çš„æ•´ä¸ªåœ°å€å­—ç¬¦ä¸²
            console.log("æˆ‘çš„åœ°å€"+loc);
            var n1 = loc.length;//åœ°å€çš„æ€»é•¿
            var n2 = loc.indexOf("?");//å–å¾—=å·çš„ä½ç½®
            var parameter = decodeURI(loc.substr(n2+1, n1-n2));//æˆªå–ä»?å·åé¢çš„å†…å®¹,ä¹Ÿå°±æ˜¯å‚æ•°åˆ—è¡¨ï¼Œå› ä¸ºä¼ è¿‡æ¥çš„è·¯å¾„æ˜¯åŠ äº†ç çš„ï¼Œæ‰€ä»¥è¦è§£ç 
            var parameters  = parameter.split("&");//ä»&å¤„æ‹†åˆ†ï¼Œè¿”å›å­—ç¬¦ä¸²æ•°ç»„
            console.log("å‚æ•°åˆ—è¡¨"+parameters);
            var paValue = new Array();//åˆ›å»ºä¸€ä¸ªç”¨äºä¿å­˜å…·ä½“å€¼å¾—æ•°ç»„
            for (var i = 0; i < parameters.length; i++) {
                console.log("å‚æ•°é”®å€¼å¯¹å€¼"+i+":"+parameters[i]);
                var m1 = parameters[i].length;//è·å¾—æ¯ä¸ªé”®å€¼å¯¹çš„é•¿åº¦
                var m2 = parameters[i].indexOf("=");//è·å¾—æ¯ä¸ªé”®å€¼å¯¹=å·çš„ä½ç½®
                var value = parameters[i].substr(m2+1, m1-m2);//è·å–æ¯ä¸ªé”®å€¼å¯¹=å·åé¢å…·ä½“çš„å€¼
                paValue[i] = value;
                var id =  value;
            }
            if(id == loc){
                self.suFlag = 'save';
                return
            }else{
                self.suFlag = 'update';
                self.newsForm.id = id;
                var url = self.urls.initNews + "?id=" + id;
                axios.get(url)
                    .then(function(res){
                        console.log(res.data);
                        var title = document.getElementById("newsTitle");
                        title.value = res.data.newsTitle;
                        editor.txt.html(res.data.newsContent);
                    });
            }
        },
        filters: {},
        mounted: function () {

        },
        methods: {
            backIndex(){
                window.location.href = "/editNews";
            },
            submitForm() {
                var self = this;
                this.newsForm.newsContent = editor.txt.html();
                if (this.newsForm.newsContent.length > 4000){
                    self.$message({
                        message: 'æ–°é—»å†…å®¹è¿‡é•¿ï¼',
                        type: 'warning'
                    });
                    return false;
                }
                this.newsForm.newsTitle = document.getElementById("newsTitle").value;
                if (this.newsForm.newsTitle == '' || this.newsForm.newsTitle == null){
                    self.$message({
                        message: 'æ–°é—»æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼',
                        type: 'warning'
                    });
                    return false;
                }
                if (this.newsForm.newsTitle.length > 30){
                    self.$message({
                        message: 'æ–°é—»æ ‡é¢˜é•¿åº¦ä¸èƒ½è¶…è¿‡30ä¸ªå­—ç¬¦ï¼',
                        type: 'warning'
                    });
                    return false;
                }
                if (this.suFlag == 'save'){
                    var url = self.urls.insertNews;
                }else{
                    var url = self.urls.updateNews;
                    this.newsForm.newsTitle = document.getElementById("newsTitle").value;
                    this.newsForm.newsContent = editor.txt.html();
                }
                axios.post(url, self.newsForm)
                    .then(function(res){
                        console.log(res);
                        self.$message({
                            message: 'æ–°é—»å·²å‘å¸ƒæˆåŠŸï¼Œ2ç§’åè·³è½¬åˆ°ç®¡ç†ç•Œé¢ï¼',
                            type: 'success'
                        });
                        setTimeout("javascript:location.href='editNews'", 2000);
                    });
            },
            resetForm(formName) {
                this.$refs[formName].resetFields();
            }

        },
        watch: {}
    });
</script>
</html>